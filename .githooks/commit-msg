#!/usr/bin/env bash
#
# Git commit-msg hook - Validates Conventional Commits format
# See: https://www.conventionalcommits.org/
#
# Installed by: uv run poe bootstrap or ./devsetup.sh
# Skip with: git commit --no-verify
#

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip merge commits
if [[ "$COMMIT_MSG" =~ ^Merge ]]; then
    exit 0
fi

# Skip revert commits
if [[ "$COMMIT_MSG" =~ ^Revert ]]; then
    exit 0
fi

PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-zA-Z0-9,_-]+\))?(!)?: .{1,}$"

FIRST_LINE=$(echo "$COMMIT_MSG" | head -n 1)

if [[ ! "$FIRST_LINE" =~ $PATTERN ]]; then
    echo ""
    echo -e "${RED}ERROR: Invalid commit message format${NC}"
    echo ""
    echo "Your message:"
    echo -e "${YELLOW}  $FIRST_LINE${NC}"
    echo ""
    echo "Expected format:"
    echo -e "${GREEN}  <type>(<scope>): <subject>${NC}"
    echo ""
    echo "Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
    echo ""
    echo "Examples:"
    echo -e "  ${GREEN}feat(auth): add OAuth2 login${NC}"
    echo -e "  ${GREEN}fix(api): handle null response${NC}"
    echo -e "  ${GREEN}docs: update README${NC}"
    echo -e "  ${GREEN}feat(api)!: breaking change${NC}"
    echo ""
    echo "See CONTRIBUTING.md for full guidelines."
    echo ""
    exit 1
fi

SUBJECT_LENGTH=${#FIRST_LINE}

if [[ $SUBJECT_LENGTH -gt 72 ]]; then
    echo ""
    echo -e "${RED}ERROR: Commit subject too long ($SUBJECT_LENGTH chars)${NC}"
    echo "Maximum: 72 characters"
    echo ""
    exit 1
fi

if [[ $SUBJECT_LENGTH -gt 50 ]]; then
    echo -e "${YELLOW}WARNING: Commit subject is $SUBJECT_LENGTH chars (50 recommended)${NC}"
fi

if [[ "$FIRST_LINE" =~ \.$ ]]; then
    echo ""
    echo -e "${RED}ERROR: Commit subject should not end with a period${NC}"
    echo ""
    exit 1
fi

exit 0
