#!/usr/bin/env bash
#
# Pre-commit hook
# Runs code quality checks before allowing a commit
#

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Ensure uv is in PATH (for VS Code and other GUI git clients)
export PATH="$HOME/.local/bin:$HOME/.cargo/bin:/usr/local/bin:$PATH"

# Protected branches
PROTECTED_BRANCHES=("main" "master")

current_branch=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")

for branch in "${PROTECTED_BRANCHES[@]}"; do
    if [ "$current_branch" = "$branch" ]; then
        echo -e "${RED}Error: Direct commits to '$branch' are not allowed!${NC}"
        echo ""
        echo "Please create a feature branch and submit a pull request:"
        echo "  git checkout -b feature/your-feature-name"
        echo ""
        exit 1
    fi
done

echo -e "${YELLOW}Running pre-commit checks...${NC}"

if ! command -v uv &> /dev/null; then
    echo -e "${RED}Error: uv is not installed${NC}"
    exit 1
fi

if command -v prek &> /dev/null || uv run prek --version &> /dev/null 2>&1; then
    prek run --hook-stage pre-commit 2>/dev/null || uv run prek run --hook-stage pre-commit || {
        echo -e "${RED}Pre-commit checks failed. Please fix the issues and try again.${NC}"
        exit 1
    }
else
    echo "Running ruff format check..."
    uv run ruff format --check src tests 2>/dev/null || {
        echo -e "${RED}Formatting issues found. Run 'uv run poe format' to fix.${NC}"
        exit 1
    }

    echo "Running ruff lint..."
    uv run ruff check src tests 2>/dev/null || {
        echo -e "${RED}Linting issues found. Run 'uv run poe lint' to fix.${NC}"
        exit 1
    }
fi

if command -v bd &> /dev/null && [ -d ".beads" ]; then
    bd hooks run pre-commit 2>/dev/null || true
fi

echo -e "${GREEN}Pre-commit checks passed!${NC}"
